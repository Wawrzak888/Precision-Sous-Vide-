<!DOCTYPE html>
<html lang="pl" class="dark">
<head>
    <meta charset="UTF-8">
    <!-- Kluczowa linia blokująca skalowanie i poprawiająca wygląd na mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Precision Sous Vide Calculator</title>
    
    <!-- === KONFIGURACJA PWA (IKONY I PEŁNY EKRAN) === -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Kolor paska statusu (bateria/wifi) -->
    <meta name="theme-color" content="#082f49">
    
    <!-- Ustawienia dla Androida -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Ustawienia dla iOS (iPhone) - to ukrywa pasek na Apple -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sous Vide">
    
    <!-- === IKONA STARTOWA APLIKACJI === -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3361/3361127.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3361/3361127.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        science: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9', // Sky blue
                            700: '#0369a1',
                            900: '#0c4a6e',
                            950: '#082f49', // Deep Navy
                        },
                        alert: {
                            DEFAULT: '#ef4444', 
                            safe: '#10b981', 
                        },
                        veg: {
                            DEFAULT: '#84cc16', 
                        }
                    },
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Bezpieczny obszar dla iPhone z notchem (wcięcia w ekranie) */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        :root {
            --thumb-color: #0ea5e9; 
            --thumb-shadow: rgba(14, 165, 233, 0.5);
        }

        /* Styl suwaka */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px; 
            width: 24px;
            border-radius: 50%;
            background: var(--thumb-color);
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 0 10px var(--thumb-shadow);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        /* Animacje detali */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0% {opacity: 0; transform: translateY(-10px)} 100% {opacity: 1; transform: translateY(0)} }
        
        /* Inwersja ikony zegara w time pickerze */
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-science-950 text-slate-200 font-sans min-h-screen flex flex-col antialiased selection:bg-science-500 selection:text-white">

    <!-- Header -->
    <header class="border-b border-slate-800 bg-science-900/50 sticky top-0 z-10 backdrop-blur-md">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <!-- Ikona SVG w nagłówku -->
                <div class="w-8 h-8 bg-science-500 rounded flex items-center justify-center text-science-950 shadow-lg shadow-science-500/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white">Sous Vide</h1>
                    <p class="text-[10px] text-slate-400 font-mono uppercase tracking-wider">Baldwin Model v2.5</p>
                </div>
            </div>
            <div class="text-right hidden sm:block">
                <div class="text-xs text-science-500 font-mono">SYSTEM READY</div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 sm:p-6 pb-12">
        <div class="max-w-3xl mx-auto space-y-6">
            
            <!-- Left Column: Inputs -->
            <div class="space-y-5">
                <div class="glass-panel rounded-xl p-5 shadow-2xl ring-1 ring-white/5">
                    <h2 class="text-xs font-bold text-science-500 uppercase tracking-widest mb-4 border-b border-slate-700/50 pb-2">Konfiguracja</h2>
                    <div class="space-y-4">
                        <!-- Product Selection -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="col-span-2">
                                <label class="block text-[10px] text-slate-400 uppercase mb-1 font-bold">Produkt</label>
                                <select id="meatType" class="w-full bg-slate-800/80 border border-slate-700 rounded-lg px-3 py-3 text-sm focus:border-science-500 focus:ring-1 focus:ring-science-500 outline-none transition text-white appearance-none">
                                    <option value="poultry_chicken">Drób - Kurczak</option>
                                    <option value="poultry_turkey">Drób - Indyk</option>
                                    <option value="pork">Wieprzowina</option>
                                    <option value="beef">Wołowina</option>
                                    <option value="fish">Ryba</option>
                                    <option value="eggs">Jajka</option>
                                    <option value="veg">Warzywa i Owoce</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-[10px] text-slate-400 uppercase mb-1 font-bold">Element</label>
                                <select id="meatCut" class="w-full bg-slate-800/80 border border-slate-700 rounded-lg px-3 py-3 text-sm focus:border-science-500 focus:ring-1 focus:ring-science-500 outline-none transition text-white appearance-none">
                                    <!-- Populated via JS -->
                                </select>
                            </div>
                        </div>

                        <!-- Texture Goal (Conditional) -->
                        <div id="textureControlPanel" class="transition-opacity duration-300 pt-2">
                            <label class="block text-[10px] text-slate-400 uppercase mb-2 font-bold">Preferowana Tekstura</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button type="button" class="texture-btn active py-3 text-xs font-medium rounded-lg text-center transition-all bg-science-600 text-white shadow-lg shadow-science-900/50 border border-transparent" data-value="dinner">
                                    Obiad<br><span class="text-[9px] opacity-80 font-normal">Soczyste / Miękkie</span>
                                </button>
                                <button type="button" class="texture-btn py-3 text-xs font-medium rounded-lg text-center text-slate-400 border border-slate-700 hover:bg-slate-800 transition-all" data-value="sandwich">
                                    Kanapka<br><span class="text-[9px] opacity-60 font-normal">Zwarte / Krojenie</span>
                                </button>
                            </div>
                        </div>

                        <!-- Thickness -->
                        <div class="pt-2">
                            <div class="flex justify-between items-end mb-4">
                                <label class="text-[10px] text-slate-400 uppercase font-bold">Grubość</label>
                                <span class="text-2xl font-mono text-science-400 font-bold"><span id="thicknessVal">25</span><span class="text-sm text-slate-500 ml-1 font-normal">mm</span></span>
                            </div>
                            <input type="range" id="thickness" min="5" max="100" value="25" step="1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-[9px] text-slate-600 mt-2 font-mono uppercase">
                                <span>Cienkie (5mm)</span>
                                <span>Grube (100mm)</span>
                            </div>
                        </div>

                        <!-- Advanced Options Collapsible -->
                        <details class="group border-t border-slate-800 pt-3 mt-2">
                            <summary class="flex cursor-pointer items-center justify-between text-[10px] font-bold text-slate-500 uppercase hover:text-science-400 transition list-none">
                                <span>Zaawansowane (Kształt / Mrożone)</span>
                                <span class="transition transform group-open:rotate-180 text-lg">▾</span>
                            </summary>
                            <div class="grid grid-cols-2 gap-4 pt-4 animate-fade-in">
                                <div>
                                    <label class="block text-[9px] text-slate-400 mb-1">Kształt</label>
                                    <select id="shape" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-2 text-xs outline-none">
                                        <option value="slab">Płyta / Stek</option>
                                        <option value="cylinder">Walec / Rolada</option>
                                        <option value="sphere">Kula</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[9px] text-slate-400 mb-1">Stan</label>
                                    <select id="state" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-2 text-xs outline-none">
                                        <option value="fresh">Świeże (+5°C)</option>
                                        <option value="frozen">Mrożone (-18°C)</option>
                                    </select>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Main Display -->
                <div class="glass-panel rounded-xl p-1 shadow-2xl ring-1 ring-white/5 relative overflow-hidden mt-6">
                    <div id="statusBar" class="absolute top-0 left-0 w-1.5 h-full bg-alert-safe transition-colors duration-500"></div>
                    <div class="p-5 pl-7">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Temperatura Wody</h2>
                                <div class="text-4xl font-bold font-mono text-white tracking-tighter flex items-baseline gap-1">
                                    <span id="targetTemp">60.0</span><span class="text-xl text-science-500">°C</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div id="safetyBadge" class="inline-flex items-center px-2 py-1 rounded text-[10px] font-bold bg-alert-safe/10 text-alert-safe border border-alert-safe/20 tracking-wide">
                                    PASTERYZACJA
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-6 border-t border-slate-700/50 pt-5">
                            <div>
                                <p class="text-[10px] font-bold text-slate-500 uppercase mb-1" id="minTimeLabel">Minimum</p>
                                <div class="text-2xl font-mono text-slate-200" id="minTime">00:00</div>
                                <p class="text-[9px] text-slate-500 mt-0.5 leading-tight" id="minTimeSub">Bezpieczeństwo</p>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-science-500 uppercase mb-1">Optimum</p>
                                <div class="text-3xl font-mono text-science-400 font-bold" id="optTime">00:00</div>
                                <p class="text-[9px] text-slate-500 mt-0.5 leading-tight">Idealna tekstura</p>
                            </div>
                        </div>
                        
                        <!-- Progress Bar Visual -->
                        <div class="mt-5 h-1.5 w-full bg-slate-800 rounded-full overflow-hidden flex">
                             <div id="visHeat" class="bg-blue-500 h-full opacity-80"></div>
                             <div id="visPast" class="bg-green-500 h-full opacity-80"></div>
                             <div id="visTend" class="bg-amber-500 h-full opacity-80"></div>
                        </div>
                        <div class="flex justify-between text-[9px] text-slate-500 mt-1 font-mono uppercase">
                            <span>Nagrzewanie</span>
                            <span>Pasteryzacja</span>
                            <span>Kruszenie</span>
                        </div>

                        <div id="warningContainer" class="hidden mt-4 p-3 bg-alert/10 border border-alert/30 rounded text-alert text-xs font-mono flex items-start gap-2">
                            <span class="text-lg">⚠️</span> <span id="warningText">Warning message here.</span>
                        </div>
                    </div>
                </div>

                <!-- Meal Planner -->
                <div class="glass-panel rounded-xl p-4 border border-slate-800 bg-science-900/20 flex items-center justify-between gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Gotowe na godzinę:</label>
                        <input type="time" id="targetTime" class="bg-slate-800 border border-slate-700 text-white text-lg rounded px-3 py-1 focus:outline-none focus:border-science-500 transition w-32 text-center font-bold font-mono">
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-slate-500 uppercase mb-0.5">Wstaw o:</p>
                        <div class="text-2xl font-mono font-bold text-alert-safe" id="startTime">--:--</div>
                    </div>
                </div>
                
                <!-- Expert Note (Sticky Bottom Look) -->
                <div class="border-l-2 border-science-500 pl-3 py-1">
                     <p id="expertNote" class="text-xs text-slate-300 italic leading-relaxed">
                        Wybierz produkt, aby zobaczyć notatkę eksperta.
                    </p>
                </div>

                <!-- === FOOTER: AUTOR & NAUKA === -->
                <footer class="mt-8 pt-6 border-t border-slate-800/50 text-center space-y-4 opacity-60 hover:opacity-100 transition-opacity duration-500">
                    <div class="space-y-1">
                        <p class="text-[10px] uppercase tracking-widest font-bold text-science-500">Fundament Naukowy</p>
                        <p class="text-[9px] leading-relaxed text-slate-400 max-w-md mx-auto">
                            Obliczenia termodynamiczne i pasteryzacyjne oparte na pracach matematycznych <strong>dr. Douglasa Baldwina</strong> oraz standardach bezpieczeństwa żywności <strong>FDA/USDA</strong>.
                            <br>Parametry dla warzyw wg metodologii <strong>Modernist Cuisine</strong>.
                        </p>
                    </div>
                    
                    <div class="pt-2">
                        <p class="text-[9px] text-slate-500 uppercase tracking-wider">
                            Projekt i Implementacja
                        </p>
                        <p class="text-[11px] font-bold text-slate-300 tracking-wide mt-0.5">
                            Tomasz Wawrzak
                        </p>
                        <p class="text-[9px] text-slate-600 mt-1">
                            Version 2.5 • Precision Cooking Tool
                        </p>
                    </div>
                </footer>

            </div>
        </div>
    </main>

    <script>
        // --- CONSTANTS ---
        const ALPHA = {
            fish: 0.995e-7, poultry: 1.08e-7, meat: 1.11e-7, eggs: 1.08e-7,
            veg: 1.4e-7 
        };

        const PATHOGENS = {
            poultry: { d60: 4.68, z: 6.45, targetLog: 7.0 },
            meat: { d60: 5.48, z: 6.00, targetLog: 6.5 },
            fish: { d60: 10, z: 7, targetLog: 6.0 },
            eggs: { d60: 4.68, z: 6.45, targetLog: 5.0 },
            veg: { d60: 0.1, z: 10, targetLog: 1.0 } 
        };

        const CUTS = {
            poultry_chicken: [{id:'breast',name:'Pierś'},{id:'thigh',name:'Udko'}],
            poultry_turkey: [{id:'breast',name:'Pierś'},{id:'thigh',name:'Udko'}],
            pork: [{id:'loin',name:'Schab'},{id:'tenderloin',name:'Polędwiczka'},{id:'ham',name:'Szynka'},{id:'neck',name:'Karkówka'},{id:'shoulder',name:'Łopatka'},{id:'belly',name:'Boczek'}],
            beef: [{id:'steak',name:'Stek'},{id:'chuck',name:'Karkówka'},{id:'round',name:'Ligawa'},{id:'brisket',name:'Mostek'}],
            fish: [{id:'fillet',name:'Filet'},{id:'steak',name:'Dzwonko'}],
            eggs: [{id:'soft',name:'Onsen (63°C)'},{id:'medium',name:'Idealne (65.5°C)'},{id:'hard',name:'Na twardo (74°C)'},{id:'raw_safe',name:'Pasteryzowane'}],
            veg: [
                {id:'root', name:'Korzeniowe (Marchew, Ziemniak)'},
                {id:'green', name:'Zielone (Szparagi, Brokuł)'},
                {id:'fruit_hard', name:'Owoce Twarde (Gruszka)'},
                {id:'fruit_soft', name:'Owoce Miękkie (Śliwka)'}
            ]
        };

        const SHAPE_MODIFIERS = {
            slab: { multiplier: 1.0 },
            cylinder: { multiplier: 0.65 },
            sphere: { multiplier: 0.45 }
        };

        const state = { meatType: 'poultry_chicken', meatCut: 'breast', textureGoal: 'dinner', thicknessMm: 25, shape: 'slab', state: 'fresh' };
        
        const els = {
            meatType: document.getElementById('meatType'), meatCut: document.getElementById('meatCut'),
            textureBtns: document.querySelectorAll('.texture-btn'), thickness: document.getElementById('thickness'),
            thicknessVal: document.getElementById('thicknessVal'), shape: document.getElementById('shape'),
            state: document.getElementById('state'), textureControlPanel: document.getElementById('textureControlPanel'),
            targetTemp: document.getElementById('targetTemp'), minTime: document.getElementById('minTime'),
            optTime: document.getElementById('optTime'), safetyBadge: document.getElementById('safetyBadge'),
            warningContainer: document.getElementById('warningContainer'), warningText: document.getElementById('warningText'),
            expertNote: document.getElementById('expertNote'), 
            visHeat: document.getElementById('visHeat'), visPast: document.getElementById('visPast'),
            visTend: document.getElementById('visTend'), targetTime: document.getElementById('targetTime'),
            startTime: document.getElementById('startTime'), minTimeLabel: document.getElementById('minTimeLabel'),
            minTimeSub: document.getElementById('minTimeSub')
        };

        function init() {
            populateCuts();
            setupListeners();
            calculate();
        }

        function setupListeners() {
            els.meatType.addEventListener('change', (e) => {
                state.meatType = e.target.value;
                if(state.meatType === 'eggs') { state.shape = 'sphere'; els.shape.value = 'sphere'; state.thicknessMm = 50; els.thickness.value=50; els.thicknessVal.textContent=50; }
                if(state.meatType === 'veg') { state.shape = 'cylinder'; els.shape.value = 'cylinder'; }
                populateCuts(); calculate();
            });
            els.meatCut.addEventListener('change', (e) => { state.meatCut = e.target.value; calculate(); });
            els.thickness.addEventListener('input', (e) => { state.thicknessMm = parseInt(e.target.value); els.thicknessVal.textContent = state.thicknessMm; calculate(); });
            els.shape.addEventListener('change', (e) => { state.shape = e.target.value; calculate(); });
            els.state.addEventListener('change', (e) => { state.state = e.target.value; calculate(); });
            els.targetTime.addEventListener('input', () => calculate());
            els.textureBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    els.textureBtns.forEach(b => { 
                        b.classList.remove('bg-science-600', 'text-white', 'active', 'shadow-lg'); 
                        b.classList.add('text-slate-400', 'border-slate-700');
                    });
                    btn.classList.add('bg-science-600', 'text-white', 'active', 'shadow-lg'); 
                    btn.classList.remove('text-slate-400', 'border-slate-700');
                    state.textureGoal = btn.dataset.value; calculate();
                });
            });
        }

        function populateCuts() {
            const cuts = CUTS[state.meatType];
            els.meatCut.innerHTML = '';
            cuts.forEach(cut => {
                const opt = document.createElement('option'); opt.value = cut.id; opt.textContent = cut.name; els.meatCut.appendChild(opt);
            });
            state.meatCut = cuts[0].id;
        }

        function updatePlanner(durationHours) {
            if (!els.targetTime.value) { els.startTime.textContent = "--:--"; return; }
            const [tH, tM] = els.targetTime.value.split(':').map(Number);
            const target = new Date(); target.setHours(tH, tM, 0, 0);
            const start = new Date(target.getTime() - durationHours * 3600000);
            els.startTime.textContent = `${String(start.getHours()).padStart(2,'0')}:${String(start.getMinutes()).padStart(2,'0')}`;
        }

        function calculate() {
            const isVeg = state.meatType === 'veg';
            const isEgg = state.meatType === 'eggs';
            
            if (isEgg || isVeg) { els.textureControlPanel.style.opacity = '0'; els.textureControlPanel.style.pointerEvents = 'none'; }
            else { els.textureControlPanel.style.opacity = '1'; els.textureControlPanel.style.pointerEvents = 'auto'; }

            if(isVeg) {
                document.documentElement.style.setProperty('--thumb-color', '#84cc16');
                document.documentElement.style.setProperty('--thumb-shadow', 'rgba(132, 204, 22, 0.5)');
            } else {
                document.documentElement.style.setProperty('--thumb-color', '#0ea5e9');
                document.documentElement.style.setProperty('--thumb-shadow', 'rgba(14, 165, 233, 0.5)');
            }

            // Calculation Logic
            let alpha = ALPHA[state.meatType.includes('poultry') ? 'poultry' : state.meatType] || ALPHA.meat;
            const shapeMod = SHAPE_MODIFIERS[state.shape];
            const rec = getRecommendation(state.meatType, state.meatCut, state.textureGoal);
            const T_target = rec.temp;
            
            const L = state.thicknessMm / 1000;
            let heatTimeSec = (Math.pow(L, 2)) / (4 * alpha) * shapeMod.multiplier;
            if (state.state === 'frozen') heatTimeSec *= 1.5;
            
            let heatTimeHours = heatTimeSec / 3600;

            let pathogen = PATHOGENS[state.meatType.includes('poultry') ? 'poultry' : state.meatType] || PATHOGENS.meat;
            let pasteurTimeMin = 0;
            let isPasteurPossible = T_target >= 54.0;

            if (!isVeg && isPasteurPossible) {
                const exp = (60 - T_target) / pathogen.z;
                const D_val = pathogen.d60 * Math.pow(10, exp);
                pasteurTimeMin = pathogen.targetLog * D_val;
            }

            let totalMinMinutes = (heatTimeSec / 60) + pasteurTimeMin;
            let totalMinHours = Math.ceil(totalMinMinutes) / 60;

            let finalOptHours = rec.time;
            finalOptHours = Math.max(finalOptHours, heatTimeHours);
            
            if (!isVeg && !isEgg && isPasteurPossible) finalOptHours = Math.max(finalOptHours, totalMinHours);
            if (isVeg) { finalOptHours = heatTimeHours + rec.time; totalMinHours = heatTimeHours; }
             if (isEgg) { finalOptHours = Math.max(rec.time, heatTimeHours); totalMinHours = heatTimeHours + (isPasteurPossible ? (pasteurTimeMin/60) : 0); }

            els.targetTemp.textContent = T_target.toFixed(1);
            
            if (isVeg) {
                els.minTimeLabel.textContent = "Ogrzanie";
                els.minTimeSub.textContent = "Heat Pen.";
                els.safetyBadge.textContent = "ROZPAD PEKTYNY";
                els.safetyBadge.className = "inline-flex items-center px-2 py-1 rounded text-[10px] font-bold bg-veg/20 text-veg border border-veg/30 tracking-wide";
            } else {
                els.minTimeLabel.textContent = "Minimum";
                els.minTimeSub.textContent = "Bezpieczeństwo";
                els.safetyBadge.textContent = isPasteurPossible ? "PASTERYZACJA" : "HEAT ONLY";
                if(state.meatType==='eggs' && !isPasteurPossible) els.safetyBadge.textContent = "SUROWE";
                els.safetyBadge.className = "inline-flex items-center px-2 py-1 rounded text-[10px] font-bold bg-alert-safe/20 text-alert-safe border border-alert-safe/30 tracking-wide";
            }

            const formatH = (h) => {
                const hr = Math.floor(h);
                const mn = Math.round((h % 1)*60);
                return `${hr}h ${String(mn).padStart(2,'0')}m`;
            };
            els.minTime.textContent = formatH(totalMinHours);
            els.optTime.textContent = formatH(finalOptHours);

            let note = rec.note;
            if (state.state === 'frozen') note += " (Czas rozmrażania wliczony).";
            els.expertNote.textContent = note;

            updateVisuals(isVeg, isEgg, heatTimeHours, totalMinHours, finalOptHours);
            updatePlanner(finalOptHours);
        }

        function updateVisuals(isVeg, isEgg, heatH, safeH, optH) {
            let totalS = optH * 3600 || 1;
            let heatPct = (heatH * 3600 / totalS) * 100;
            
            if(isVeg) {
                let tendPct = 100 - heatPct;
                els.visHeat.style.width = `${heatPct}%`;
                els.visPast.style.width = `0%`;
                els.visTend.style.width = `${tendPct}%`;
                els.visTend.className = "bg-veg h-full opacity-80";
            } else {
                let safeS = safeH * 3600;
                let pastS = safeS - (heatH * 3600);
                if(pastS < 0) pastS = 0;
                let pastPct = (pastS / totalS) * 100;
                let tendPct = 100 - heatPct - pastPct;
                
                els.visHeat.style.width = `${heatPct}%`;
                els.visPast.style.width = `${pastPct}%`;
                els.visTend.style.width = `${tendPct}%`;
                els.visTend.className = "bg-amber-500 h-full opacity-80";
            }
        }

        function getRecommendation(type, cut, goal) {
            let temp=60, time=2, note="";
            if (type === 'veg') {
                if (cut === 'root') { temp = 85.0; time = 1.0; note = "Korzeniowe: 85°C min. do miękkości."; } 
                else if (cut === 'green') { temp = 84.0; time = 0.25; note = "Zielone: Krótko, aby zachować kolor."; } 
                else if (cut === 'fruit_hard') { temp = 84.0; time = 0.5; note = "Twarde owoce: Zmiękną, ale zachowają kształt."; } 
                else if (cut === 'fruit_soft') { temp = 80.0; time = 0.25; note = "Miękkie owoce: Niższa temp. zapobiega papce."; }
                return {temp, time, note};
            }
            if (type === 'eggs') {
                if (cut === 'soft') { temp = 63.0; time = 0.75; note = "Onsen: Płynne białko, kremowe żółtko."; }
                else if (cut === 'medium') { temp = 65.5; time = 1.0; note = "Custard: Idealna, plastyczna konsystencja."; }
                else if (cut === 'hard') { temp = 74.0; time = 1.0; note = "Na twardo: Ścięte, ale wilgotne."; }
                else if (cut === 'raw_safe') { temp = 57.0; time = 2.0; note = "Bezpieczne surowe (do majonezu/kogla-mogla)."; }
                return {temp, time, note};
            }
            if (type === 'poultry_chicken') {
                if (cut === 'breast') { return goal==='dinner' ? {temp:60.5, time:1.5, note:"Super soczysta pierś."} : {temp:63.5, time:2.5, note:"Pierś tradycyjna/zwarta."}; }
                if (cut === 'thigh') return {temp:65.0, time:3, note:"Ciemne mięso wymaga wyższej temperatury."};
            }
            if (type === 'poultry_turkey') {
                if (cut === 'breast') { return goal==='dinner' ? {temp:62.0, time:2.5, note:"Pierś indyka."} : {temp:65.0, time:4, note:"Szynka z piersi indyka."}; }
                if (cut === 'thigh') return {temp:65.0, time:4, note:"Udko indyka: Dużo kolagenu."};
            }
            if (type === 'pork') {
                if (['loin','tenderloin','ham'].includes(cut)) return goal==='dinner' ? {temp:58.0, time:2.5, note:"Schab: Różowy i soczysty."} : {temp:61.0, time:4, note:"Schab: Biały, tradycyjny."};
                if (['shoulder','neck'].includes(cut)) return goal==='dinner' ? {temp:57.0, time:24, note:"Karkówka 'stekowa' (24h)."} : {temp:74.0, time:18, note:"Pulled Pork (rozpadająca się)."};
                if (cut === 'belly') return {temp:80.0, time:8, note:"Boczek: Miękki i rozpływający się."};
            }
            if (type === 'beef') {
                if (cut === 'steak') return goal==='dinner' ? {temp:54.0, time:1.5, note:"Stek Medium-Rare (Krwisty)."} : {temp:56.0, time:2, note:"Stek Medium (Średni)."};
                if (['chuck','round'].includes(cut)) return goal==='dinner' ? {temp:56.0, time:24, note:"Pieczeń 24h (zmięknie jak polędwica)."} : {temp:55.0, time:36, note:"Deli Roast Beef."};
                if (cut === 'brisket') return {temp:63.0, time:48, note:"Mostek 48h: Klasyka BBQ (bez dymu)."};
            }
            if (type === 'fish') return {temp:50.0, time:0.5, note:"Ryba: Delikatna, 'szklista' struktura."};
            
            return {temp:60, time:2, note:""};
        }

        init();
    </script>
</body>
</html>
